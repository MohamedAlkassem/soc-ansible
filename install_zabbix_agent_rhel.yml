---
- name: Full Zabbix Agent setup on RHEL 9 servers
  hosts: fleet-node,manger-node      # عدّلها حسب الـ groups عندك في AWX
  become: yes

  vars:
    zabbix_server_ip: "192.168.10.246"   # IP الزبكس سيرفر عندك

  tasks:
    - name: Disable securityonion repo if it exists
      ansible.builtin.shell: "sed -i 's/^enabled=1/enabled=0/' /etc/yum.repos.d/securityonion*.repo"
      args:
        warn: false
      ignore_errors: yes

    - name: Clean dnf cache
      ansible.builtin.command: dnf clean all
      changed_when: false

    - name: Install Zabbix repository package (RHEL 9)
      ansible.builtin.dnf:
        name: "https://repo.zabbix.com/zabbix/6.4/rhel/9/x86_64/zabbix-release-6.4-1.el9.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Make sure Zabbix repos metadata is up to date
      ansible.builtin.command: dnf makecache
      changed_when: false

    - name: Install Zabbix agent
      ansible.builtin.dnf:
        name: zabbix-agent
        state: present

    - name: Configure Server= in zabbix_agentd.conf
      ansible.builtin.lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Server='
        line: "Server={{ zabbix_server_ip }}"
        backup: yes

    - name: Configure ServerActive= in zabbix_agentd.conf
      ansible.builtin.lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^ServerActive='
        line: "ServerActive={{ zabbix_server_ip }}"

    - name: Configure Hostname= in zabbix_agentd.conf (use inventory hostname)
      ansible.builtin.lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Hostname='
        line: "Hostname={{ inventory_hostname }}"

    - name: Ensure firewall port 10050/tcp is open
      ansible.builtin.firewalld:
        port: 10050/tcp
        permanent: true
        state: enabled
      ignore_errors: yes

    - name: Reload firewalld
      ansible.builtin.command: firewall-cmd --reload
      changed_when: false
      ignore_errors: yes

    - name: Enable and restart Zabbix agent service
      ansible.builtin.systemd:
        name: zabbix-agent
        state: restarted
        enabled: yes
